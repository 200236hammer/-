<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>è¨­å®šç”»é¢ï¼ˆãƒ•ãƒ«çµ±åˆç‰ˆï¼‰</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .tab-button { margin-right: 6px; padding: 6px 10px; }
    .tab-button.active { font-weight: bold; border-bottom: 2px solid #333; }
    .tab-content { display: none; margin-top: 12px; }
    .tab-content.active { display: block; }
    .config-item { margin: 16px 0; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
    .config-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .section-title { font-weight: 600; margin: 16px 0 6px; }
    .inline-input { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .inline-input input[type="text"] { width: 320px; }
    .inline-input .short { width: 160px; }
    .inline-input .mini { width: 110px; }
    .list { margin-top: 6px; }
    .info-item { display: flex; align-items: center; gap: 6px; margin: 6px 0; border: 1px solid #ddd; padding: 6px; border-radius: 4px; flex-wrap: wrap; }
    .info-item .display-names-wrapper { display: flex; gap: 6px; flex-wrap: wrap; }
    .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    label { margin-right: 6px; }
    .id-label { margin-right: 6px; }
    .btn { padding: 4px 8px; }
    .btn-small { padding: 2px 6px; }
    .group-box { border: 1px dashed #bbb; padding: 10px; border-radius: 6px; margin: 8px 0; }
    .muted { color: #666; font-size: 12px; }
    .topline { margin-top: 14px; border-top: 1px solid #eee; padding-top: 10px; }
    .savebar { margin-top: 16px; display: flex; gap: 8px; }
  </style>
</head>

<body>
<h1>ãƒã‚¹ãƒ«ãƒ¼ãƒˆ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®š</h1>

<div class="config-item">
  <div class="section-title">Google Maps APIã‚­ãƒ¼ï¼ˆå…±é€šï¼‰</div>
  <div class="inline-input">
    <input type="text" id="apiKeyCommon" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" style="width:420px;">
  </div>
  <div class="muted">â€» ãƒ¬ã‚³ãƒ¼ãƒ‰ç”»é¢ãƒ»ä¸€è¦§ç”»é¢ã®ä¸¡æ–¹ã§å…±é€šåˆ©ç”¨ã—ã¾ã™</div>
</div>

<div id="tabs">
  <button type="button" class="tab-button active" data-tab="record">ãƒ¬ã‚³ãƒ¼ãƒ‰ç”»é¢</button>
  <button type="button" class="tab-button" data-tab="list">ä¸€è¦§ç”»é¢</button>
</div>

<div id="tab-contents">
  <div class="tab-content active" id="tab-record">
    <div class="config-header">
      <div class="section-title" style="margin:0;">ãƒ¬ã‚³ãƒ¼ãƒ‰ç”»é¢ ç”¨ è¨­å®š</div>
      <div><button type="button" id="add-record-config" class="btn">ï¼‹ è¨­å®šè¿½åŠ </button></div>
    </div>
    <div class="record-configs"></div>
  </div>
  <div class="tab-content" id="tab-list">
    <div class="config-header">
      <div class="section-title" style="margin:0;">ä¸€è¦§ç”»é¢ ç”¨ è¨­å®š</div>
      <div><button type="button" id="add-list-config" class="btn">ï¼‹ è¨­å®šè¿½åŠ </button></div>
    </div>
    <div class="list-configs"></div>
  </div>
</div>

<div class="savebar">
  <button type="button" id="save" class="btn">ä¿å­˜</button>
  <span class="muted">â€» ã„ã£ãŸã‚“ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä¿å­˜å†…å®¹ã‚’å‡ºåŠ›ã—ã¾ã™</span>
</div>

<!-- ================= Templates ================= -->
<template id="config-template">
  <div class="config-item">
    <div class="config-header">
      <div class="muted">ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ 1 ã¤ã®ã€Œè¨­å®šã€ã§ã™</div>
      <button type="button" class="remove-config btn-small">ï¼ è¨­å®šå‰Šé™¤</button>
    </div>

    <div class="inline-input">
      <label class="id-label"></label>
      <input type="text" class="recordOrViewId short" placeholder="">
    </div>

    <div class="section-title topline">GPX URL</div>
    <div class="gpx-list list"></div>
    <button type="button" class="add-gpx btn-small">ï¼‹ è¿½åŠ </button>

    <div class="section-title topline">åŒºåˆ†ã‚»ãƒƒãƒˆ</div>
    <div class="types-list list"></div>
    <button type="button" class="add-type-set btn-small">ï¼‹ è¿½åŠ </button>

    <div class="section-title topline">é™¤å»æ–‡å­—åˆ—</div>
    <div class="removeStrs-list list"></div>
    <button type="button" class="add-removeStr btn-small">ï¼‹ è¿½åŠ </button>

    <div class="section-title topline">åœ°ç‚¹ã‚¯ãƒªãƒƒã‚¯è¡¨ç¤º</div>
    <div class="pointKintone-list list"></div>
    <button type="button" class="add-pointKintone btn-small">ï¼‹ è¿½åŠ </button>

    <div class="section-title topline">ãƒ«ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯è¡¨ç¤º</div>
    <div class="routeKintone-list list"></div>
    <button type="button" class="add-routeKintone btn-small">ï¼‹ è¿½åŠ </button>

    <div class="section-title topline">ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯æ¡ä»¶</div>
    <div class="group-box">
      <div class="section-title" style="margin-top:0;">ä¹—è»Šåœ°ç‚¹æ¡ä»¶</div>
      <div class="boarding-conds list"></div>
      <button type="button" class="add-boarding-cond btn-small">ï¼‹ è¿½åŠ </button>

      <div class="section-title" style="margin-top:12px;">é™è»Šåœ°ç‚¹æ¡ä»¶</div>
      <div class="alighting-conds list"></div>
      <button type="button" class="add-alighting-cond btn-small">ï¼‹ è¿½åŠ </button>
      <div class="muted">ä¾‹ï¼‰InfoWindowã«ã€Œä¹—è»Šã€ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ã€kintoneã® <code>boarding_bus_stop</code> ã§ä¸€è‡´æ¤œç´¢</div>
    </div>

    <div class="section-title topline">GPX &lt;name&gt; ã¨ kintoneãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¯¾å¿œï¼ˆãƒ«ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯ç”¨ï¼‰</div>
    <div class="mapping-list list"></div>
    <div class="inline-input">
      <button type="button" class="add-mapping btn-small">ï¼‹ è¡Œè¿½åŠ </button>
      <button type="button" class="remove-mapping btn-small">ï¼ æœ«å°¾å‰Šé™¤</button>
    </div>

    <div class="inline-input topline">
      <label>è·é›¢100mæœªæº€é»’ç·š:</label>
      <select class="blackIfShort mini">
        <option value="true">ã™ã‚‹</option>
        <option value="false">ã—ãªã„</option>
      </select>
    </div>
  </div>
</template>

<template id="gpx-item-template">
  <div class="inline-input">
    <input type="text" class="gpxUrl" placeholder="https://.../file.gpx">
    <button type="button" class="remove-btn btn-small">ï¼</button>
  </div>
</template>

<template id="row-text-template">
  <div class="inline-input">
    <input type="text" class="text-input" placeholder="">
    <button type="button" class="remove-btn btn-small">ï¼</button>
  </div>
</template>

<template id="type-set-template">
  <div class="row type-set-row">
    åŒºåˆ†å: <input type="text" class="type-name mini" placeholder="ä¾‹ï¼šé«˜é€Ÿãƒã‚¹">
    <div class="colors-wrapper" style="margin-left:8px;">
      <div class="color-list"></div>
      <button type="button" class="add-color btn-small">ï¼‹ è‰²è¿½åŠ </button>
      <button type="button" class="remove-color btn-small">ï¼ è‰²å‰Šé™¤</button>
      <button type="button" class="rainbow-color btn-small">ğŸŒˆ è™¹è‰²</button>
    </div>

    <select class="line-type mini">
      <option value="solid">å®Ÿç·š</option>
      <option value="dashed">ç ´ç·š</option>
      <option value="wave">æ³¢ç·š</option>
    </select>

    <select class="legend mini">
      <option value="true">å‡¡ä¾‹è¡¨ç¤ºã™ã‚‹</option>
      <option value="false">å‡¡ä¾‹è¡¨ç¤ºã—ãªã„</option>
    </select>

    <input type="text" class="icon-url" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL" style="width:220px;">
    <button type="button" class="remove-type-set btn-small">ï¼</button>
  </div>
</template>

<template id="color-item-template">
  <div class="row color-row">
    è‰²: <input type="color" class="color-value mini" value="#ff0000">
  </div>
</template>

<template id="info-item-template">
  <div class="info-item">
    <select class="data-source mini">
      <option value="kintone">kintone</option>
      <option value="gpx">GPX</option>
    </select>
    <input type="text" class="field-name mini" placeholder="é …ç›®å">
    <div class="display-names-wrapper">
      <input type="text" class="display-name mini" placeholder="è¡¨ç¤ºå">
      <button type="button" class="add-display-name btn-small">ï¼‹</button>
    </div>
    <button type="button" class="move-up btn-small">â†‘</button>
    <button type="button" class="move-down btn-small">â†“</button>
    <button type="button" class="remove-info-item btn-small">ï¼</button>
  </div>
</template>

<template id="cond-item-template">
  <div class="row">
    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: <input type="text" class="cond-key mini">
    ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: <input type="text" class="cond-field mini">
    <button type="button" class="remove-btn btn-small">ï¼</button>
  </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let currentTab = 'record';
  document.querySelectorAll('.tab-button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
      currentTab = btn.dataset.tab;
    });
  });

  function addRowFromTemplate(wrapper, templateId, removerSelector='.remove-btn') {
    const t = document.getElementById(templateId).content.cloneNode(true);
    wrapper.appendChild(t);
    const row = wrapper.lastElementChild;
    const rm = row.querySelector(removerSelector);
    if(rm) rm.onclick = ()=>row.remove();
    return row;
  }

  function addTypeSetRow(wrapper) {
    const row = addRowFromTemplate(wrapper,'type-set-template','.remove-type-set');
    setupTypeSet(row);
    return row;
  }

  function setupTypeSet(typeRow) {
    const colorList = typeRow.querySelector('.color-list');
    typeRow.querySelector('.add-color').onclick = ()=>addRowFromTemplate(colorList,'color-item-template');
    typeRow.querySelector('.remove-color').onclick = ()=>{ if(colorList.lastElementChild) colorList.lastElementChild.remove(); };
    typeRow.querySelector('.rainbow-color').onclick = ()=>{
      const rainbow=['#ff0000','#ffa500','#ffff00','#00ff00','#0000ff','#4b0082','#8b00ff'];
      colorList.querySelectorAll('.color-value').forEach((c,i)=>c.value=rainbow[i%rainbow.length]);
    };
    addRowFromTemplate(colorList,'color-item-template');
    addRowFromTemplate(colorList,'color-item-template');
  }

  function addConfig(containerSelector) {
    const container = document.querySelector(containerSelector);
    const t = document.getElementById('config-template').content.cloneNode(true);
    container.appendChild(t);
    const config = container.lastElementChild;
    config.querySelector('.remove-config').onclick = ()=>config.remove();
    const typesList = config.querySelector('.types-list');
    config.querySelector('.add-type-set').onclick = ()=>addTypeSetRow(typesList);

    // GPXè¿½åŠ 
    const gpxList = config.querySelector('.gpx-list');
    config.querySelector('.add-gpx').onclick = ()=>addRowFromTemplate(gpxList,'gpx-item-template');

    // é™¤å»æ–‡å­—åˆ—
    const removeStrsList = config.querySelector('.removeStrs-list');
    config.querySelector('.add-removeStr').onclick = ()=>addRowFromTemplate(removeStrsList,'row-text-template');

    // åœ°ç‚¹ã‚¯ãƒªãƒƒã‚¯
    const pointKintoneList = config.querySelector('.pointKintone-list');
    config.querySelector('.add-pointKintone').onclick = ()=>addRowFromTemplate(pointKintoneList,'row-text-template');

    // ãƒ«ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯
    const routeKintoneList = config.querySelector('.routeKintone-list');
    config.querySelector('.add-routeKintone').onclick = ()=>addRowFromTemplate(routeKintoneList,'row-text-template');

    // ä¹—è»Šæ¡ä»¶
    const boardingList = config.querySelector('.boarding-conds');
    config.querySelector('.add-boarding-cond').onclick = ()=>addRowFromTemplate(boardingList,'cond-item-template');

    // é™è»Šæ¡ä»¶
    const alightingList = config.querySelector('.alighting-conds');
    config.querySelector('.add-alighting-cond').onclick = ()=>addRowFromTemplate(alightingList,'cond-item-template');

    // GPX<name>å¯¾å¿œ
    const mappingList = config.querySelector('.mapping-list');
    config.querySelector('.add-mapping').onclick = ()=>addRowFromTemplate(mappingList,'info-item-template');
    config.querySelector('.remove-mapping').onclick = ()=>{ if(mappingList.lastElementChild) mappingList.lastElementChild.remove(); };
  }

  document.getElementById('add-record-config').onclick = ()=>addConfig('.record-configs');
  document.getElementById('add-list-config').onclick = ()=>addConfig('.list-configs');

  document.getElementById('save').onclick = ()=>{
    const data={ apiKey:document.getElementById('apiKeyCommon').value, recordConfigs:[], listConfigs:[] };
    ['record','list'].forEach(tab=>{
      const container=document.querySelector(`.${tab}-configs`);
      container.querySelectorAll('.config-item').forEach(c=>{
        const cfg={};
        cfg.id=c.querySelector('.recordOrViewId').value;
        cfg.gpxUrls=Array.from(c.querySelectorAll('.gpxUrl')).map(x=>x.value);
        cfg.types=Array.from(c.querySelectorAll('.type-set-row')).map(t=>{
          return {
            name:t.querySelector('.type-name').value,
            lineType:t.querySelector('.line-type').value,
            legend:t.querySelector('.legend').value,
            iconUrl:t.querySelector('.icon-url').value,
            colors:Array.from(t.querySelectorAll('.color-row .color-value')).map(r=>r.value)
          };
        });
        cfg.removeStrs=Array.from(c.querySelectorAll('.removeStrs-list .text-input')).map(x=>x.value);
        cfg.pointKintone=Array.from(c.querySelectorAll('.pointKintone-list .text-input')).map(x=>x.value);
        cfg.routeKintone=Array.from(c.querySelectorAll('.routeKintone-list .text-input')).map(x=>x.value);
        cfg.boardingConds=Array.from(c.querySelectorAll('.boarding-conds .row')).map(r=>({key:r.querySelector('.cond-key').value, field:r.querySelector('.cond-field').value}));
        cfg.alightingConds=Array.from(c.querySelectorAll('.alighting-conds .row')).map(r=>({key:r.querySelector('.cond-key').value, field:r.querySelector('.cond-field').value}));
        cfg.mapping=Array.from(c.querySelectorAll('.mapping-list .info-item')).map(i=>({
          dataSource:i.querySelector('.data-source').value,
          field:i.querySelector('.field-name').value,
          displayNames:Array.from(i.querySelectorAll('.display-name')).map(d=>d.value)
        }));
        cfg.blackIfShort=c.querySelector('.blackIfShort').value;
        data[tab+'Configs'].push(cfg);
      });
    });
    console.log(data);
    alert('ä¿å­˜å†…å®¹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸ');
  };
});
</script>
</body>
</html>
